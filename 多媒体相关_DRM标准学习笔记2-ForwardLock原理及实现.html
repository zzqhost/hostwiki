<html>
  <head>
    <title>DRM标准学习笔记2－ForwardLock原理及实现</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="Stylesheet" type="text/css" href="cssandjs/style.css" />
</head>


<body>


<div id="container">
    <div id="header">张志强的wiki</div>
    <br class="clearfloat" />
    <div id="content">

<h1 id="toc_1"> DRM标准学习笔记2－ForwardLock原理及实现</h1>

<div class="toc">
<ul>
<li><a href="#toc_1"> DRM标准学习笔记2－ForwardLock原理及实现</a>
<ul>
<li><a href="#toc_1.1">1. ForwardLock</a>
<li><a href="#toc_1.2">2. ForwardLock工作流程</a>
<li><a href="#toc_1.3">3. 符合ForwardLocak标准的DRM文件格式</a>
<li><a href="#toc_1.4">4. Android中如何实现ForwardLocak?</a>
<li><a href="#toc_1.5">5. Android中DRM代码结构分析</a>
</ul>
</ul>
</div>

<h2 id="toc_1.1">1. ForwardLock</h2>
<ul>
<li>
ForwardLock 是DRM1.0中最简单的一种传输方式。请参考<a href="多媒体相关_DRM标准学习笔记1.html">DRM标准学习笔记1</a>

</ul>

<h2 id="toc_1.2">2. ForwardLock工作流程</h2>
<ol>
<li>
用特定工具，或者是手动编写，将一个普通的视频文件（例如mp4) 生成一个符合标准的DRM文件，放到服务器上；

<li>
用户付费后，用下载工具将此DRM文件下载到本地；

<li>
下载工具必须支持这种DRM文件，下载的时候，其内部实际上是把此DRM文件进行了加密，加密算法可以采用AES等算法。密钥应该是每台机器生成一个唯一的密钥，加密和解密密钥是相同的。

<li>
这样，在本地端就有了一个加密的媒体文件，用户可以在本机上进行播放，但如果COPY到另外的机器上，由于密钥不同，所以不以成功解密，这样就达到了ForwardLock的目的。

</ol>

<h2 id="toc_1.3">3. 符合ForwardLocak标准的DRM文件格式</h2>
<ul>
<li>
如下所示的格式：
<pre>
    --boundary12345\r\n
    Content-type: video/mp4\r\n
    Content-Transfer-Encoding: binary\r\n
    \r\n
      .
      .
      .\r\n
    --boundary12345--\r\n
</pre>

<li>
说明：

<ul>
<li>
DRM文件格式其实就是在原始的媒体文件加了一个头和一个尾。如上所示。

<li>
头一共增加了四行，在这里我把隐藏字符也用转义字写出来，目的就是为了看清楚。

<li>
第一行是以--开头，后跟一个随机的字符串，但结尾时也必须是这个字符串。然后是回车换行。

<li>
第二行是说明此文件的mime type是什么

<li>
第三行说的是编码格式，是二进制，还是64 base。

<li>
第四行是一个空行。

<li>
然后是原始的媒体文件，这里用三个点的三行来进行表示。

<li>
最后，在原始文件的末尾先来一个回车换行

<li>
最后一行是以--开头和结尾，中间放上跟头一样的字符串，回车换行。

</ul>
</ul>

<h2 id="toc_1.4">4. Android中如何实现ForwardLocak?</h2>
<ul>
<li>
最后，目前的Android代码（Android4.1JB）是支持此功能的，即通过Browser下载的时候，如果是FrowardLocak文件则会进行文件的加密。

<li>
如果想自己写一个来玩玩，可以用以下的代码实现：
<pre>
    mDrmManagerClient = new DrmManagerClient();
    mConvertSessionID = mDrmManagerClient-&gt;openConvertSession(s_imetype);

    ...

    DrmBuffer buffer((char *)data, (int)size);
    DrmConvertedStatus *convertedStatus =
           mDrmManagerClient-&gt;convertData(mConvertSessionID, &amp;buffer);

    int write_len = writeConvertedStatusToFile(convertedStatus, mDrmOffset + offset);

    ...

    // close drm session and write drm file size.
    convertedStatus = mDrmManagerClient-&gt;closeConvertSession(mConvertSessionID);
    writeConvertedStatusToFile(convertedStatus);

    // delete the instance.
    delete mDrmManagerClient;
    mDrmManagerClient=NULL;
</pre>

<li>
说明：

<ul>
<li>
writeConvertedStatusToFile是我写的一个处理转换结果的私有函数，主要是把结果convertedStatus中的数据进行保存。

<li>
在最后，关闭ConvertSession后，还会返回一个convertedStatus，这里边也包含数据，并且多包含了一个offset，位置正好位于头部，这里存的是整个文件的大小，因为大小只有在整个转换完成，关闭时才会知道。

<li>
另外，如果想对一个普通的媒体文件进行加密，则需要自己加上DRM的头和尾然后用此类的实例进行转换。

</ul>
</ul>

<h2 id="toc_1.5">5. Android中DRM代码结构分析</h2>
<ul>
<li>
代码位置

<ul>
<li>
frameworks/base/drm/   (DRM的Java和JNI代码)

<ul>
<li>
java/

<li>
jni/

</ul>
<li>
frameworks/av/drm/    (DRM的Native层代码，包括引擎和服务)

<ul>
<li>
common/

<li>
drmserver/

<li>
libdrmframework/

<ul>
<li>
DrmManagerClient.cpp

<li>
include/

<li>
plugins/

</ul>
</ul>
<li>
frameworks/base/media/ (此路径中有关DRM的代码可能是遗留代码，目前还不知道有什么用)

<ul>
<li>
libdrm/mobile1/

<li>
java/drm/

</ul>
</ul>
</ul>
</div>
    <br class="clearfloat" />


    <div id="disqus_thread"></div>
    <script type="text/javascript" src="cssandjs/javascript/tongjianddisqus.js"></script>

    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    <div id="footer">
            zzqhost&nbsp;&copy;&nbsp;2012-2013&nbsp;
            <a href="http://www.zzqhost.com" target="_blank">www.zzqhost.com</a>
            <br>
            Generated by
            <a href="http://www.vim.org" target="_blank">Vim</a>
            &amp;
            <a href="http://code.google.com/p/vimwiki/" target="_blank">Vimwiki</a>
    </div>

</div>

</body>
</html>
